# ğŸ  Housing Service Prediction Microservice

This Flask-based microservice provides a `/predict` endpoint that returns a risk score based on anonymized housing-related application data. It's designed to be called by an external service â€” such as a Nest.js backend â€” at `http://localhost:5000/predict`.

> ğŸ“¢ **Note**: If you're running this with Docker or Kubernetes, make sure to update the hostname/IP in your Nest.js `application-service` to reflect the correct endpoint.

---

## ğŸ“ Folder Structure

```
model/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # Flask app with /predict endpoint
â”‚   â””â”€â”€ model.pkl            # Trained XGBoost model (generated by utils/train_model.py)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ train_model.py       # Script to generate training data and save model.pkl
â”‚   â””â”€â”€ test_prediction.py   # Sends test POST request to /predict endpoint
â”œâ”€â”€ Dockerfile               # For containerizing the Flask microservice
â”œâ”€â”€ requirements.txt         # Python dependencies
â”œâ”€â”€ deployment.yaml          # Kubernetes Deployment config
â”œâ”€â”€ service.yaml             # Kubernetes Service config
â””â”€â”€ README.md                # Youâ€™re here!
```

---

## ğŸ§ª Test Locally (No Docker or Kubernetes)

1. **Set up your virtual environment**:

   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

2. **Install dependencies**:

   ```bash
   pip install -r requirements.txt
   ```

3. **Train the model** (this creates `app/model.pkl`):

   ```bash
   python utils/train_model.py
   ```

4. **Start the Flask app**:

   First, move into the `app/` directory:

   ```bash
   cd app
   python main.py
   ```

   The microservice will be running at:  
   `http://localhost:5000/predict`

5. **Test the endpoint**:

   (in a separate terminal, from the model/ directory):

   ```bash
   python utils/test_prediction.py
   ```

---

## ğŸ³ Run with Docker

1. **Build the image**:

   ```bash
   docker build -t housing-service .  
   ```

2. **Run the container**:

   ```bash
   docker run -p 5000:5000 housing-service
   ```

3. **Test the endpoint** (in another terminal):

   ```bash
   python utils/test_prediction.py
   ```

---

## â˜¸ï¸ Run with Kubernetes (Minikube)

### ğŸ”§ Start Minikube

```bash
minikube start
```

If you're using local Docker images:

```bash
eval $(minikube docker-env)
docker build -t housing-service .
```

### ğŸ“¦ Apply Kubernetes config

```bash
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
```

### ğŸŒ Expose the service

To forward the service to your machine's port:

```bash
kubectl port-forward housing-service-loadbalancer 5000:5000
```

Or to open it in your browser:

```bash
minikube service housing-service-loadbalancer
```

---

## ğŸ“¡ Prediction API

### `POST /predict`

Sends anonymized housing-related features to get a risk score prediction.

#### ğŸ“¥ Request Body

```json
{
  "features": {
    "income": 1800,
    "household_size": 3,
    "housing_status": 1,
    "income_vouchers": true,
    "household_expecting_changes": false,
    "household_student": true
  }
}
```

> All fields are required. `housing_status` is encoded numerically (e.g., 0: homeless, 1: renting, 2: stable).

#### ğŸ“¤ Response

```json
{
  "risk_score": 0.82,
  "message": "Risk score represents likelihood of being unhoused (0 to 1, higher is riskier)"
}
```

#### âš ï¸ Errors

- `400`: Missing or malformed fields  
- `500`: Internal server error (e.g., model not found)

---

## ğŸ” System Flow: Next.js â†’ NestJS â†’ Microservice

This diagram shows the data flow through the system:

1. A user submits their application via the **Next.js frontend**.
2. The **NestJS backend** receives the application data, anonymizes it, and sends a `POST` request to the `/predict` endpoint exposed by this Flask microservice.
3. The **Flask microservice** uses a trained ML model to compute a risk score and responds with a prediction.
4. The **NestJS backend** then returns this result to the frontend for further user interaction or display.

<p align="center">
  <img src="./images/microservice-flow.png" alt="System Flow Diagram" width="700"/>
</p>

---

## ğŸ›  Model Training

The model is trained using synthetic housing data generated by `utils/train_model.py`. It outputs `model.pkl` in the `app/` directory.

> âœ… **Best Practice**: Run this script before building your Docker image or deploying to Kubernetes.

---

## ğŸ§ª Testing

You can run `utils/test_prediction.py` to test the microservice locally or on any live deployment.

---

## ğŸ§˜ Privacy & Ethics

This service must only receive **anonymized** data â€” no names, contact info, or personally identifiable information (PII) should ever be sent.

