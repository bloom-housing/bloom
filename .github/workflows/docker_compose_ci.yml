name: Docker Compose CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  check-docker-compose:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v6

      # Blame claude if this messes with stuff
      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo docker image prune --all --force

      - name: build
        shell: bash
        run: |
          if ! docker compose build --no-cache; then
            echo 'ERROR: docker compose build failed'
            exit 1
          fi

      - name: dbinitcheck
        shell: bash
        run: |
          if ! docker compose up \
               --exit-code-from dbinit \
               db dbinit
          then
            echo 'ERROR: dbinit first execution did not exit with 0'
            exit 1
          fi

          if ! docker compose up \
               --exit-code-from dbinit \
               db dbinit
          then
            echo 'ERROR: dbinit second execution did not exit with 0'
            exit 1
          fi

          if ! docker compose down; then
            echo 'ERROR: docker compose down failed'
            exit 1
          fi

      - name: api-smoke-test
        shell: bash
        run: |
          if ! docker compose up --wait api
          then
            echo 'ERROR: api did not start successfully. Logs:'
            docker compose logs api
            exit 1
          fi

          if ! docker compose down; then
            echo 'ERROR: docker compose down failed'
            exit 1
          fi

      - name: dbreadonlycheck
        shell: bash
        run: |
          if ! COMPOSE_PROFILES=ci docker compose up \
               --exit-code-from dbreadonlycheck \
               dbreadonlycheck
          then
            echo 'ERROR: dbreadonlycheck did not exit with 0'
            exit 1
          fi

          if ! docker compose down; then
            echo 'ERROR: docker compose down failed'
            exit 1
          fi

      - name: sites-smoke-test
        shell: bash
        run: |
          if ! docker compose up --wait; then
            echo 'ERROR: docker compose up --wait did not exit with 0'
            exit 1
          fi

          if ! curl --fail http://127.0.0.1:3001; then
            echo 'ERROR: partners site is not accessible. Logs:'
            docker compose logs partners
            exit 1
          fi

          if ! curl --fail http://127.0.0.1:3000; then
            echo 'ERROR: public site is not accessible. Logs:'
            docker compose logs public
            exit 1
          fi

          if ! docker compose down; then
            echo 'ERROR: docker compose down failed'
            exit 1
          fi
